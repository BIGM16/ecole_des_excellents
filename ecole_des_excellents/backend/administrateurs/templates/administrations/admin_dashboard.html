{% extends 'core/base.html' %}
{% block title %} Espace Admin {% endblock %}
{% block content %}
<!-- Dashboard Section -->

<!-- Header des sections -->
<div class="max-w-6xl mx-auto md:mt-10 p-6 bg-white rounded-lg shadow-lg mb-6">
  <h2 class="text-3xl text-center font-bold mb-6">ESPACE ADMINISTRATEUR</h2>

  <div class="grid grid-cols-2 gap-6 mb-6">
    <button
      class="tab-btn text-xl md:text-2xl font-bold gradient-gold text-white px-2 py-2 md:px-4 md:py-4 rounded-lg"
      data-target="statistque"
    >
      Tableau de bord
    </button>
    <button
      class="tab-btn text-xl md:text-2xl font-bold gradient-gold text-black px-2 py-2 md:px-4 md:py-4 rounded-lg"
      data-target="etudiants"
    >
      G√©rer les √©tudiants
    </button>
    <button
      class="tab-btn text-xl md:text-2xl font-bold gradient-gold text-black px-2 py-2 md:px-4 md:py-4 rounded-lg"
      data-target="encadreurs"
    >
      G√©rer les encadreurs
    </button>
    <button
      class="tab-btn text-xl md:text-2xl font-bold gradient-gold text-black px-2 py-2 md:px-4 md:py-4 rounded-lg"
      data-target="cours"
    >
      G√©rer les cours
    </button>
  </div>
</div>

<!-- =================================== -->
<!--  SECTION1 : SECTION TABLEAU DE BORD -->
<!-- =================================== -->

<section id="statistque" class="tab-section p-6">
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-600 text-sm">Total √âtudiants</p>
          <p class="text-3xl font-bold text-gray-800">{{ nb_etudiants }}</p>
        </div>
        <div
          class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
        >
          <span class="text-blue-600 text-2xl">üéì</span>
        </div>
      </div>
      <div class="mt-4">
        <span class="text-green-600 text-sm">‚Üó +12% ce mois</span>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-600 text-sm">Encadreurs Actifs</p>
          <p class="text-3xl font-bold text-gray-800">{{ nb_encadreurs }}</p>
        </div>
        <div
          class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"
        >
          <span class="text-green-600 text-2xl">üë®‚Äçüè´</span>
        </div>
      </div>
      <div class="mt-4">
        <span class="text-green-600 text-sm">‚Üó +3 nouveaux</span>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-600 text-sm">Cours Disponibles</p>
          <p class="text-3xl font-bold text-gray-800">{{ nb_cours }}</p>
        </div>
        <div
          class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"
        >
          <span class="text-yellow-600 text-2xl">üìö</span>
        </div>
      </div>
      <div class="mt-4">
        <span class="text-blue-600 text-sm">8 mis √† jour</span>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-600 text-sm">Taux de R√©ussite</p>
          <p class="text-3xl font-bold text-gray-800">94.2%</p>
        </div>
        <div
          class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"
        >
          <span class="text-purple-600 text-2xl">üìà</span>
        </div>
      </div>
      <div class="mt-4">
        <span class="text-green-600 text-sm">‚Üó +2.1% vs ann√©e derni√®re</span>
      </div>
    </div>
  </div>

  {% comment %}
  <!-- Charts -->
  <div class="grid lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-lg font-bold mb-4">√âvolution des Inscriptions</h3>
      <canvas id="enrollmentChart" width="400" height="200"></canvas>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-lg font-bold mb-4">R√©partition par Promotion</h3>
      <canvas id="promotionChart" width="400" height="200"></canvas>
    </div>
  </div>
  {% endcomment %}

  <!-- Recent Activities -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h3 class="text-lg font-bold mb-4">Activit√©s R√©centes</h3>
    <div class="space-y-4">
      <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
        <div
          class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
        >
          <span class="text-blue-600">üë§</span>
        </div>
        <div class="flex-1">
          <p class="font-medium">Nouvel √©tudiant inscrit</p>
          <p class="text-sm text-gray-600">Marie Dupont - 1√®re Ann√©e</p>
        </div>
        <span class="text-sm text-gray-500">Il y a 2h</span>
      </div>
      <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
        <div
          class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"
        >
          <span class="text-green-600">üìö</span>
        </div>
        <div class="flex-1">
          <p class="font-medium">Cours mis √† jour</p>
          <p class="text-sm text-gray-600">Anatomie - Syst√®me nerveux</p>
        </div>
        <span class="text-sm text-gray-500">Il y a 4h</span>
      </div>
      <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
        <div
          class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center"
        >
          <span class="text-yellow-600">üë®‚Äçüè´</span>
        </div>
        <div class="flex-1">
          <p class="font-medium">Nouvel encadreur ajout√©</p>
          <p class="text-sm text-gray-600">Dr. Ahmed Benali - Cardiologie</p>
        </div>
        <span class="text-sm text-gray-500">Hier</span>
      </div>
    </div>
  </div>
</section>

<!-- =================================== -->
<!--     SECTION2 : SECTION ETUDIANTS    -->
<!-- =================================== -->

<section id="etudiants" class="tab-section hidden p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Gestion des √âtudiants</h2>
    <button
      onclick="openModal('etudiantModal')"
      class="gradient-gold text-black px-4 py-2 rounded-lg font-medium"
    >
      ‚ûï Ajouter un √âtudiant
    </button>
  </div>

  <!-- Stats √âtudiants -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-blue-600">210</div>
      <div class="text-sm text-gray-600">1√®re Ann√©e</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-green-600">198</div>
      <div class="text-sm text-gray-600">2√®me Ann√©e</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-yellow-600">185</div>
      <div class="text-sm text-gray-600">3√®me Ann√©e</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
      <div class="text-2xl font-bold text-purple-600">172</div>
      <div class="text-sm text-gray-600">4√®me Ann√©e</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <form method="get" class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Promotion
        </label>
        <select
          name="promotion"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        >
          <option value="all" selected>Toutes les promotions</option>
          {% for value, label in promotion_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Recherche
        </label>
        <input
          type="text"
          name="q"
          id="search-input"
          placeholder="Nom, email..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
    </form>
  </div>

  <!-- √âtudiants Table -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <table id="etudiantsTable" class="w-full overflow-x-auto min-w-max">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            √âtudiant
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Promotion
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Telephone
          </th>
          <th
            class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="etudiantsBody" class="divide-y divide-gray-200">
        {% for e in etudiants %}
        <tr>
          <td class="px-6 py-4">
            <div class="flex items-center space-x-3">
              <div
                class="bg-green-100 rounded-full flex items-center justify-center"
              >
                <img
                  src="{% if e.photo and e.photo.url %} {{ e.photo.url }} {% else %} {{ MEDIA_URL }}default.png {% endif %}"
                  alt="Photo de profil"
                  class="h-20 w-20 rounded-full border"
                />
              </div>
              <div>
                <div class="font-medium">{{ e.user.username }}</div>
                <div class="text-sm text-gray-500">{{e.user.email }}</div>
              </div>
            </div>
          </td>
          <td>{{ e.get_promotion_display }}</td>
          <td>
            <span class="text-lg font-bold text-red-600">
              {{ e.telephone }}</span
            >
          </td>
          <td class="text-center">
            <div class="flex justify-center space-x-2">
              <a
                href="{% url 'administrateurs:edit_etudiant' e.id %}"
                class="text-blue-600 hover:text-blue-800"
                >‚úèÔ∏è</a
              >
              <a
                href="{% url 'administrateurs:delete_etudiant' e.id %}"
                class="text-red-600 hover:text-red-800"
                onclick="return confirm('Supprimer cet √©tudiant ?')"
                >üóëÔ∏è</a
              >
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4">Aucun etudiants</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="flex justify-center mt-4">
    {% if etudiants.has_previous %}
    <a
      href="?page={{ etudiants.previous_page_number }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Pr√©c√©dent</a
    >
    {% endif %}
    <span class="px-4"
      >Page {{ etudiants.number }} / {{ etudiants.paginator.num_pages }}</span
    >
    {% if etudiants.has_next %}
    <a
      href="?page={{ etudiants.next_page_number }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Suivant</a
    >
    {% endif %}
  </div>
  <div
    id="etudiantModal"
    class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Ajouter un Nouvel √âtudiant</h3>
        <button
          onclick="closeModal('etudiantModal')"
          class="text-gray-500 hover:text-gray-700"
        >
          ‚úï
        </button>
      </div>
      <form
        method="POST"
        enctype="multipart/form-data"
        class="grid grid-cols-2 gap-2 bg-gray-50 p-4 rounded"
      >
        {% csrf_token %}
        <input type="hidden" name="form_type" value="etudiant" />
        {{ form_etudiant.as_p }}
        <div class="flex justify-end space-x-4 mt-10">
          <button
            type="button"
            onclick="closeModal('etudiantModal')"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="px-4 py-2 gradient-gold text-black rounded-lg font-medium"
          >
            Ajouter l'√âtudiant
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- =================================== -->
<!--     SECTION3 : SECTION ENCADREURS   -->
<!-- =================================== -->

<!-- Encadreurs Section -->
<section id="encadreurs" class="tab-section p-6 hidden">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Gestion des Encadreurs</h2>
    <button
      onclick="openModal('encadreurModal')"
      class="gradient-gold text-black px-4 py-2 rounded-lg font-medium"
    >
      ‚ûï Ajouter un Encadreur
    </button>
  </div>

  <!-- Filters -->

  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <form method="get" class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Promotion
        </label>
        <select
          id="promotionEncadreur"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        >
          <option value="" selected>Toutes les promotions</option>
          {% for value, label in promotion_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Recherche
        </label>
        <input
          type="text"
          id="searchEncadreur"
          placeholder="Nom, email..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
    </form>
  </div>

  <!-- Encadreurs Grid -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <table id="encadreurTable" class="w-full min-w-max overflow-x-auto">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Encadreurs
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Promotion
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            T√©l√©phone
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="encadreurBody" class="divide-y divide-gray-200">
        {% for en in encadreurs %}
        <tr>
          <td class="px-6 py-4">
            <div class="flex items-center space-x-3">
              <div
                class="bg-green-100 rounded-full flex items-center justify-center"
              >
                <img
                  src="{% if en.photo and en.photo.url %} {{ en.photo.url }} {% else %} {{ MEDIA_URL }}default.png {% endif %}"
                  alt="Photo de profil"
                  class="h-20 w-20 rounded-full border"
                />
              </div>
              <div>
                <div class="font-medium">{{ en.user.username }}</div>
                <div class="text-sm text-gray-500">{{en.user.email }}</div>
              </div>
            </div>
          </td>
          {% comment %}
          <td>{{ en.nom }}</td>
          {% endcomment %}
          <td>{{ en.get_promotion_display }}</td>
          <td>
            <span class="text-lg font-bold text-red-600"
              >{{ en.telephone }}</span
            >
          </td>
          <td class="text-center px-6 py-4 text-sm">
            <div class="flex space-x-2">
              <a
                href="{% url 'administrateurs:edit_etudiant' en.id %}"
                class="text-blue-600 hover:text-blue-800"
                >‚úèÔ∏è</a
              >
              <a
                href="{% url 'administrateurs:delete_etudiant' en.id %}"
                class="text-red-600 hover:text-red-800"
                onclick="return confirm('Supprimer cet encadreur ?')"
                >üóëÔ∏è</a
              >
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4">Aucun encadreurs</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="flex justify-center mt-4">
    {% if encadreurs.has_previous %}
    <a
      href="?page={{ encadreurs.previous_page_number }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Pr√©c√©dent</a
    >
    {% endif %}
    <span class="px-4"
      >Page {{ encadreurs.number }} / {{ encadreurs.paginator.num_pages }}</span
    >
    {% if encadreurs.has_next %}
    <a
      href="?page={{ encadreurs.next_page_number }}"
      class="px-3 py-1 bg-gray-200 rounded"
      >Suivant</a
    >
    {% endif %}
  </div>

  <div
    id="encadreurModal"
    class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Ajouter un Nouvel Encadreur</h3>
        <button
          onclick="closeModal('encadreurModal')"
          class="text-gray-500 hover:text-gray-700"
        >
          ‚úï
        </button>
      </div>
      <form
        method="POST"
        enctype="multipart/form-data"
        class="grid grid-cols-2 gap-2 bg-gray-50 p-4 rounded"
      >
        {% csrf_token %}
        <input type="hidden" name="form_type" value="encadreur" />
        {{ encadreur_form.as_p }}
        <div
          class="flex justify-center align-center space-x-4 mt-10 col-span-2"
        >
          <button
            type="button"
            onclick="closeModal('encadreurModal')"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="px-4 py-2 gradient-gold text-black rounded-lg font-medium"
          >
            Ajouter l'Encadreur
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- ============================= -->
<!--    SECTION3 : COURS ET PDFS   -->
<!-- ============================= -->
<!-- Cours Section -->
<section id="cours" class="tab-section p-6 hidden">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Gestion des Cours</h2>
    <button
      onclick="openModal('coursModal')"
      class="gradient-gold text-black px-4 py-2 rounded-lg font-medium"
    >
      ‚ûï Ajouter un Cours
    </button>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Promotion</label
        >
        <select
          id="promotionCours"
          name="promotion"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        >
          <option value="all" selected>Toutes les promotions</option>
          {% for value, label in promotion_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Mati√®re</label
        >
        <input
          id="matiereCours"
          name="matiere"
          type="text"
          placeholder="Mati√®re (ex: Anatomie)"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Recherche</label
        >
        <input
          id="searchCours"
          type="text"
          placeholder="Rechercher..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
    </div>
  </div>

  <!-- Cours Table -->
  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <table class="w-full overflow-x-auto">
      <thead class="bg-gray-50">
        <tr>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Cours
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Promotion
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Encadreur
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody id="coursBody" class="divide-y divide-gray-200">
        {% for c in cours_list %}
        <tr>
          <td class="px-6 py-4">
            <div>
              <div class="font-medium">{{ c.titre }}</div>
              <div class="text-sm text-gray-500">
                {{ c.documents.count }} fichiers documents
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-sm">{{ c.get_promotion_display }}</td>
          <td class="px-6 py-4 text-sm">
            {% if c.encadreur %}
            {{ c.encadreur.user.get_full_name|default:c.encadreur.user.username }}
            {% else %}
            -
            {% endif %}
          </td>
          <td class="px-6 py-4 text-sm">
            <div class="flex space-x-2">
              <a
                href="{% url 'cours:edit_cours' c.id %}"
                class="text-blue-600 hover:text-blue-800"
                >‚úèÔ∏è</a
              >
              <a
                href="{% url 'cours:delete_cours' c.id %}"
                class="text-red-600 hover:text-red-800"
                >üóëÔ∏è</a
              >
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="px-6 py-4 text-center text-gray-500">
            Aucun cours
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Cours Modal -->
  <div
    id="coursModal"
    class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">Ajouter un Nouveau Cours</h3>
        <button
          onclick="closeModal('coursModal')"
          class="text-gray-500 hover:text-gray-700"
        >
          ‚úï
        </button>
      </div>
      <form id="coursCreateForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="cours" />
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            {{ cours_form.titre.label_tag }} {{ cours_form.titre }} {% for err in cours_form.titre.errors %}
            <p class="text-red-600 text-sm">{{ err }}</p>
            {% endfor %}
          </div>
          <div>
            {{ cours_form.promotion.label_tag }} {{ cours_form.promotion }}
            {% for err in cours_form.promotion.errors %}
            <p class="text-red-600 text-sm">{{ err }}</p>
            {% endfor %}
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            {{ cours_form.description.label_tag }} {{ cours_form.description }}
            {% for err in cours_form.description.errors %}
            <p class="text-red-600 text-sm">{{ err }}</p>
            {% endfor %}
          </div>
          <div>
            {{ cours_form.encadreur.label_tag }} {{ cours_form.encadreur }}
            {% for err in cours_form.encadreur.errors %}
            <p class="text-red-600 text-sm">{{ err }}</p>
            {% endfor %}
          </div>
        </div>
        <!-- Removed fichier_pdf field: file attachments are handled per-document -->
        <div class="flex justify-end space-x-4">
          <button
            type="button"
            onclick="closeModal('coursModal')"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="px-4 py-2 gradient-gold text-black rounded-lg font-medium"
          >
            Ajouter le Cours
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  const tabs = document.querySelectorAll(".tab-btn");
  const TabSections = document.querySelectorAll(".tab-section");

  tabs.forEach((btn) => {
    btn.addEventListener("click", () => {
      console.log("tu m_as clique√©");

      tabs.forEach((b) => b.classList.remove("bg-blue-600", "text-white"));
      tabs.forEach((b) => b.classList.add("bg-gray-300", "text-black"));
      btn.classList.remove("bg-gray-300", "text-black");
      btn.classList.add("bg-blue-600", "text-white");

      TabSections.forEach((sec) => sec.classList.add("hidden"));
      document.getElementById(btn.dataset.target).classList.remove("hidden");
    });
  });

  // AJAX filtrage/recherche pour les cours
  document.addEventListener("DOMContentLoaded", function () {
    const promotionCours = document.getElementById("promotionCours");
    const matiereCours = document.getElementById("matiereCours");
    const searchCours = document.getElementById("searchCours");
    const coursBody = document.getElementById("coursBody");

    if (!coursBody || !promotionCours || !matiereCours || !searchCours) return;

    function updateCours() {
      const promotion = promotionCours.value || "all";
      const matiere = matiereCours.value.trim();
      const q = searchCours.value.trim();
      const url =
        `{% url 'administrateurs:search_cours' %}` +
        `?promotion=${encodeURIComponent(
          promotion
        )}&matiere=${encodeURIComponent(matiere)}&q=${encodeURIComponent(q)}`;

      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          coursBody.innerHTML = "";
          if (!data.results || data.results.length === 0) {
            coursBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Aucun cours trouv√©</td></tr>`;
            return;
          }

          data.results.forEach((c) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="px-6 py-4">
                <div>
                  <div class="font-medium">${c.titre}</div>
                  <div class="text-sm text-gray-500">${
                    c.documents_count
                  } fichiers documents</div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm">${c.promotion}</td>
              <td class="px-6 py-4 text-sm">${c.encadreur || "-"}</td>
              <td class="px-6 py-4 text-sm">
                <div class="flex space-x-2">
                  <a href="${
                    c.edit_url
                  }" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</a>
                  <a href="${
                    c.delete_url
                  }" class="text-red-600 hover:text-red-800">üóëÔ∏è</a>
                </div>
              </td>
            `;
            coursBody.appendChild(row);
          });
        })
        .catch((err) => console.error("Erreur recherche cours:", err));
    }

    promotionCours.addEventListener("change", updateCours);
    matiereCours.addEventListener("input", debounce(updateCours, 300));
    searchCours.addEventListener("input", debounce(updateCours, 300));
  });

  // simple debounce util
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function openModal(modalId) {
    document.getElementById(modalId).classList.add("active");
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
  }

  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const promotionSelect = document.querySelector("select[name='promotion']");
    const etudiantsBody = document.getElementById("etudiantsBody");

    if (!searchInput || !promotionSelect || !etudiantsBody) return;

    // Fonction de recherche/filtrage combin√©e
    function updateEtudiants() {
      const query = searchInput.value.trim();
      const promotion = promotionSelect.value;

      fetch(
        `/etudiant/search/?q=${encodeURIComponent(
          query
        )}&promotion=${encodeURIComponent(promotion)}`
      )
        .then((response) => response.json())
        .then((data) => {
          etudiantsBody.innerHTML = "";

          if (data.results.length === 0) {
            etudiantsBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Aucun √©tudiant trouv√©</td></tr>`;
            return;
          }

          data.results.forEach((e) => {
            const row = `
            <tr>
              <td class="px-6 py-4">
                <div class="flex items-center space-x-3">
                  <div class="bg-green-100 rounded-full flex items-center justify-center">
                    <img src="${e.photo}" alt="Photo de profil" class="h-20 w-20 rounded-full border" />
                  </div>
                  <div>
                    <div class="font-medium">${e.nom}</div>
                    <div class="text-sm text-gray-500">${e.email}</div>
                  </div>
                </div>
              </td>
              <td>${e.promotion}</td>
              <td><span class="text-lg font-bold text-red-600">${e.telephone}</span></td>
              <td class="text-center">
                <div class="flex justify-center space-x-2">
                  <a href="/etudiant/${e.id}/edit/" class="text-blue-600 hover:underline">‚úèÔ∏è</a>
                  <a href="/etudiant/${e.id}/delete/" class="text-red-600 hover:underline" onclick="return confirm('Supprimer cet √©tudiant ?')">üóëÔ∏è</a>
                </div>
              </td>
            </tr>`;
            etudiantsBody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch((err) => console.error("Erreur recherche :", err));
    }

    // √âv√©nements : recherche + filtrage
    searchInput.addEventListener("keyup", updateEtudiants);
    promotionSelect.addEventListener("change", updateEtudiants);
  });

  // AJAX creation for courses
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("coursCreateForm");
    const tbody = document.getElementById("coursBody");
    if (!form) return;

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;

      fetch('{% url "cours:create_cours_ajax" %}', {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrf },
        body: fd,
      })
        .then((r) => r.json())
        .then((res) => {
          if (res.success) {
            const c = res.cours;
            const row = document.createElement("tr");
            row.innerHTML = `
                          <td class="px-6 py-4"><div><div class="font-medium">${
                            c.titre
                          }</div><div class="text-sm text-gray-500">${
              c.documents_count
            } fichiers documents</div></div></td>
                          <td class="px-6 py-4 text-sm">${c.promotion}</td>
                          <td class="px-6 py-4 text-sm">${
                            c.encadreur || "-"
                          }</td>
                          <td class="px-6 py-4 text-sm"><div class="flex space-x-2"><a href="${
                            c.edit_url
                          }" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</a><a href="${
              c.delete_url
            }" class="text-red-600 hover:text-red-800">üóëÔ∏è</a></div></td>
                        `;
            tbody.prepend(row);
            // close modal
            closeModal("coursModal");
            form.reset();
          } else {
            alert(res.error || "Erreur cr√©ation");
          }
        })
        .catch((err) => {
          console.error(err);
          alert("Erreur r√©seau");
        });
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    const searchEncadreur = document.getElementById("searchEncadreur");
    const promotionEncadreur = document.getElementById("promotionEncadreur");
    const encadreurBody = document.getElementById("encadreurBody");

    if (!searchEncadreur || !promotionEncadreur || !encadreurBody) return;

    function filtrerEncadreurs() {
      const query = searchEncadreur.value.trim();
      const promotion = promotionEncadreur.value;

      const url = new URL(window.location.href);
      url.searchParams.set("section", "encadreurs");
      url.searchParams.set("query_encadreur", query);
      url.searchParams.set("promotion_encadreur", promotion);

      fetch(url)
        .then((response) => response.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const newBody = doc.querySelector("#encadreurBody");
          if (newBody) encadreurBody.innerHTML = newBody.innerHTML;
        })
        .catch((err) => console.error("Erreur encadreurs:", err));
    }

    searchEncadreur.addEventListener("input", filtrerEncadreurs);
    promotionEncadreur.addEventListener("change", filtrerEncadreurs);
  });
</script>

{% endblock %}
